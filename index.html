<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- Updated viewport meta tag to prevent zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diabetes Care Feedback</title>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        /* Prevent font scaling and zoom */
        input, textarea, select, button {
            font-size: 16px !important; /* Prevents iOS zoom */
        }
        /* Ensure content stays visible when keyboard appears */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function WhatsAppForm() {
            const [messages, setMessages] = React.useState([
                {
                    text: "**Thank you for joining the fight against diabetes in India!**\n\nBy consenting, you agree to have your comments saved and analyzed, helping researchers design the most innovative diabetes solutions for patients just like you. We will never store or share your name, data, or phone number and all your messages are completely anonymous. Please message \"I consent\" if you agree.",
                    isBot: true,
                    timestamp: new Date()
                }
            ]);
            const [inputText, setInputText] = React.useState('');
            const [hasConsented, setHasConsented] = React.useState(false);
            const [hasGivenFeedback, setHasGivenFeedback] = React.useState(false);

            // For testing, log responses to console
            const logResponse = (message, messageType) => {
                const response = {
                    timestamp: new Date().toISOString(),
                    messageType: messageType,
                    message: message
                };
                console.log('Response logged:', response);
            };

            const handleSend = () => {
                if (!inputText.trim()) return;

                const newMessages = [...messages, {
                    text: inputText,
                    isBot: false,
                    timestamp: new Date()
                }];

                if (!hasConsented && inputText.toLowerCase().includes('i consent')) {
                    logResponse(inputText, 'consent');
                    newMessages.push({
                        text: "Thank you! What is the biggest problem you or your family member is facing in diabetes management? Feel free to write as much as you want.",
                        isBot: true,
                        timestamp: new Date()
                    });
                    setHasConsented(true);
                } else if (hasConsented && !hasGivenFeedback) {
                    logResponse(inputText, 'primary_feedback');
                    newMessages.push({
                        text: "Thank you for your feedback! Your comments will help shape the way we look to treat diabetes in the future. Do you have anything else to share? If not, feel free to close the chat.",
                        isBot: true,
                        timestamp: new Date()
                    });
                    setHasGivenFeedback(true);
                } else if (hasConsented && hasGivenFeedback) {
                    logResponse(inputText, 'additional_feedback');
                    newMessages.push({
                        text: "Thank you for your comments!",
                        isBot: true,
                        timestamp: new Date()
                    });
                }

                setMessages(newMessages);
                setInputText('');
            };

            return (
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    height: '100vh', // Changed to full viewport height
                    maxWidth: '400px',
                    margin: '0 auto',
                    backgroundColor: '#f0f0f0',
                    borderRadius: '8px',
                    overflow: 'hidden',
                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
                }}>
                    {/* Header */}
                    <div style={{
                        backgroundColor: '#075e54',
                        color: 'white',
                        padding: '16px',
                        flexShrink: 0 // Prevent header from shrinking
                    }}>
                        <h1 style={{ margin: 0, fontSize: '18px' }}>Diabetes Care Feedback</h1>
                    </div>

                    {/* Messages area */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '16px',
                        backgroundColor: '#F5E6D3',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '16px'
                    }}>
                        {messages.map((message, index) => (
                            <div key={index} style={{
                                display: 'flex',
                                justifyContent: message.isBot ? 'flex-start' : 'flex-end'
                            }}>
                                <div style={{
                                    maxWidth: '80%',
                                    backgroundColor: message.isBot ? 'white' : '#e1ffc7',
                                    padding: '12px',
                                    borderRadius: '8px',
                                    boxShadow: '0 1px 2px rgba(0,0,0,0.1)'
                                }}>
                                    <div style={{ whiteSpace: 'pre-wrap' }}>{message.text}</div>
                                    <div style={{
                                        fontSize: '12px',
                                        color: '#999',
                                        marginTop: '4px'
                                    }}>
                                        {message.timestamp.toLocaleTimeString([], { 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        })}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Input area */}
                    <div style={{
                        padding: '16px',
                        backgroundColor: '#f0f0f0',
                        borderTop: '1px solid #ddd',
                        flexShrink: 0 // Prevent input area from shrinking
                    }}>
                        <div style={{
                            display: 'flex',
                            gap: '8px'
                        }}>
                            <input
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSend();
                                    }
                                }}
                                placeholder="Type a message"
                                style={{
                                    flex: 1,
                                    padding: '8px 16px',
                                    borderRadius: '20px',
                                    border: '1px solid #ddd',
                                    outline: 'none',
                                    fontSize: '16px', // Prevent zoom on iOS
                                    lineHeight: '1.3'
                                }}
                            />
                            <button
                                onClick={handleSend}
                                style={{
                                    backgroundColor: '#075e54',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '50%',
                                    width: '40px',
                                    height: '40px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    flexShrink: 0 // Prevent button from shrinking
                                }}
                            >
                                â†’
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WhatsAppForm />);
    </script>
</body>
</html>
